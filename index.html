<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Alumnos</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #333; }
        .filters-wrapper { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .filter-container { text-align: center; }
        .filter-container label { font-weight: bold; margin-right: 10px; display: block; margin-bottom: 5px; }
        .filter-container select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        
        /* --- ESTE ES EL CSS DEFINITIVO CON GRID --- */
        #dashboard-container {
            display: grid;
            grid-gap: 20px;
            /* Crea columnas automáticas de 320px de ancho */
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            /* Define la "altura" de cada ladrillo de la cuadrícula */
            grid-auto-rows: 20px; 
            max-width: 1600px;
            margin: 0 auto;
        }

        .student-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            box-sizing: border-box;
            transition: transform 0.2s;
        }
        /* --- FIN DE LA SECCIÓN CSS --- */
        
        .student-card:hover { transform: translateY(-5px); }
        .student-card h3 { margin-top: 0; color: #0056b3; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .student-card ul { list-style-type: none; padding: 0; }
        .student-card li { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px; font-size: 1em; }
        
        .measure-header { display: flex; align-items: center; gap: 8px; }
        .status-light { height: 12px; width: 12px; border-radius: 50%; flex-shrink: 0; }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }

        .measure-title { font-weight: bold; color: #343a40; }
        .measure-dates { font-size: 0.8em; color: #6c757d; margin: 4px 0; display: block; }
        .comments-container { margin-top: 8px; border-left: 3px solid #007bff; padding-left: 10px; }
        .comment-item { font-size: 0.9em; color: #495057; margin-bottom: 4px; }
    </style>
</head>
<body>
    <h1>Dashboard de Medidas Educativas</h1>
    <div class="filters-wrapper"><div class="filter-container"><label for="course-filter">Selecciona un curso:</label><select id="course-filter" onchange="handleCourseChange()"></select></div><div class="filter-container" id="class-filter-container" style="display: none;"><label for="class-filter">Filtrar por clase:</label><select id="class-filter" onchange="filterStudents()"></select></div></div>
    <div id="dashboard-container"><p>Por favor, selecciona un curso para empezar.</p></div>

    <script>
        const courseUrls = {
            "1º ESO": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=12873044&single=true&output=csv",
            "2º ESO": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=586029925&single=true&output=csv",
            "3º ESO": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=932856573&single=true&output=csv",
            "4º ESO": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=889532458&single=true&output=csv",
            "1º BTO": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=1339435516&single=true&output=csv",
            "2º BTO": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=732396135&single=true&output=csv"
        };
        let allStudents = {};

        function displayDashboards(studentsToShow) {
            const container = document.getElementById('dashboard-container');
            container.innerHTML = '';
            
            if (Object.keys(studentsToShow).length === 0) {
                 container.innerHTML = "<p>No hay alumnos para mostrar.</p>";
                 return;
            }

            for (const studentName in studentsToShow) {
                // El código para crear cada tarjeta no cambia
                const studentData = studentsToShow[studentName];
                const card = document.createElement('div');
                card.className = 'student-card';
                const title = document.createElement('h3');
                title.textContent = studentData.name;
                const measuresList = document.createElement('ul');

                studentData.measures.forEach(measure => {
                    const listItem = document.createElement('li');
                    const measureHeader = document.createElement('div');
                    measureHeader.className = 'measure-header';
                    const statusLight = document.createElement('span');
                    statusLight.className = 'status-light';
                    if (measure.endDate && measure.endDate.trim() !== '' && measure.endDate.trim() !== '-') {
                        statusLight.classList.add('status-red');
                    } else {
                        statusLight.classList.add('status-green');
                    }
                    const measureTitle = document.createElement('span');
                    measureTitle.className = 'measure-title';
                    measureTitle.textContent = measure.title;
                    measureHeader.appendChild(statusLight);
                    measureHeader.appendChild(measureTitle);
                    const measureDates = document.createElement('span');
                    measureDates.className = 'measure-dates';
                    measureDates.textContent = `(${measure.startDate || ''} - ${measure.endDate || ''})`;
                    listItem.appendChild(measureHeader);
                    listItem.appendChild(measureDates);
                    if (measure.comment && measure.comment.trim() !== '' && measure.comment.trim() !== '-') {
                        const validComments = measure.comment.split('||').map(c => c.trim()).filter(c => c !== '');
                        if (validComments.length > 0) {
                            const commentsContainer = document.createElement('div');
                            commentsContainer.className = 'comments-container';
                            validComments.forEach(commentText => {
                                const commentP = document.createElement('p');
                                commentP.className = 'comment-item';
                                commentP.textContent = commentText;
                                commentsContainer.appendChild(commentP);
                            });
                            listItem.appendChild(commentsContainer);
                        }
                    }
                    measuresList.appendChild(listItem);
                });
                
                card.appendChild(title);
                card.appendChild(measuresList);
                container.appendChild(card);
            }
            // --- CAMBIO CLAVE EN JAVASCRIPT ---
            // Una vez todas las fichas están en la página, llamamos a la función que las ajusta.
            applyMasonryLayout();
        }

        // --- NUEVA FUNCIÓN PARA AJUSTAR LAS FICHAS ---
        function applyMasonryLayout() {
            const container = document.getElementById('dashboard-container');
            const cards = container.querySelectorAll('.student-card');
            cards.forEach(card => {
                // 1. Obtenemos la altura real de la ficha
                const cardHeight = card.offsetHeight;
                // 2. Calculamos cuántos "ladrillos" de 20px de alto necesita
                const rowSpan = Math.ceil(cardHeight / 20);
                // 3. Le decimos a la ficha que ocupe ese número de ladrillos
                card.style.gridRowEnd = `span ${rowSpan}`;
            });
        }
        
        // El resto de funciones no necesitan cambios
        async function loadStudentData(csvUrl){document.getElementById("dashboard-container").innerHTML='<p>Cargando datos del curso...</p>',document.getElementById("class-filter-container").style.display="none",allStudents={};try{const response=await fetch(csvUrl);if(!response.ok)throw new Error("Error al cargar los datos.");const csvText=await response.text(),data=parseCSV(csvText);data.forEach(row=>{const studentName=row.Nombre_Alumno;allStudents[studentName]||(allStudents[studentName]={name:studentName,class:row.Clase,measures:[]}),allStudents[studentName].measures.push({title:row.Medida_Educativa,comment:row.Comentario,startDate:row.Fecha_Inicio,endDate:row.Fecha_Fin})}),populateClassFilter(),displayDashboards(allStudents),document.getElementById("class-filter-container").style.display="block"}catch(error){document.getElementById("dashboard-container").innerHTML=`<p style="color: red;">${error.message}</p>`}}
        function handleCourseChange(){const selectedCourse=document.getElementById("course-filter").value;if(selectedCourse){loadStudentData(courseUrls[selectedCourse])}else{document.getElementById("dashboard-container").innerHTML='<p>Por favor, selecciona un curso para empezar.</p>',document.getElementById("class-filter-container").style.display="none"}}
        function populateCourseFilter(){const courseFilter=document.getElementById("course-filter");courseFilter.innerHTML='<option value="">-- Elige un curso --</option>';for(const courseName in courseUrls){const option=document.createElement("option");option.value=courseName,option.textContent=courseName,courseFilter.appendChild(option)}}
        function populateClassFilter(){const classFilter=document.getElementById("class-filter"),classes=new Set;for(const studentName in allStudents)allStudents[studentName].class&&classes.add(allStudents[studentName].class);const sortedClasses=[...classes].sort();classFilter.innerHTML='<option value="todos">Todas las clases</option>',sortedClasses.forEach(className=>{const option=document.createElement("option");option.value=className,option.textContent=className,classFilter.appendChild(option)})}
        function filterStudents(){const selectedClass=document.getElementById("class-filter").value;if("todos"===selectedClass)return void displayDashboards(allStudents);const filteredStudents={};for(const studentName in allStudents)allStudents[studentName].class===selectedClass&&(filteredStudents[studentName]=allStudents[studentName]);displayDashboards(filteredStudents)}
        function parseCSV(text){const result=[],rows=text.trim().split(/\r?\n(?=(?:[^"]*\"[^"]*\")*[^\"]*$)/);if(rows.length<2)return result;const headers=rows[0].split(",").map(h=>h.trim());for(let i=1;i<rows.length;i++){if(""===rows[i].trim())continue;const obj={},values=rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)||[];for(let j=0;j<headers.length;j++){if(!headers[j])continue;let value=values[j]||"";value=value.trim(),"\""===value.startsWith('"')&&"\""===value.endsWith('"')&&(value=value.substring(1,value.length-1)),value=value.replace(/""/g,'"'),obj[headers[j]]=value}result.push(obj)}return result}
        populateCourseFilter();
    </script>
</body>
</html>