<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Alumnos</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #333; }
        .filters-wrapper { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .filter-container { text-align: center; }
        .filter-container label { font-weight: bold; margin-right: 10px; display: block; margin-bottom: 5px; }
        .filter-container select { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
        
        /* --- ESTE ES EL CSS CORRECTO Y FINAL --- */
        #dashboard-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* Centra las fichas horizontalmente */
            gap: 20px; /* Espacio entre las fichas */
            align-items: flex-start; /* Evita que las fichas se estiren a la misma altura */
            max-width: 1600px; /* Ancho máximo para pantallas grandes */
            margin: 0 auto; /* Centra todo el contenedor en la página */
        }

        .student-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            width: 320px; /* Ancho fijo para cada ficha */
            box-sizing: border-box;
            transition: transform 0.2s;
        }
        /* --- FIN DE LA SECCIÓN CSS CORRECTA --- */
        
        .student-card:hover { transform: translateY(-5px); }
        .student-card h3 { margin-top: 0; color: #0056b3; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .student-card ul { list-style-type: none; padding: 0; }
        .student-card li { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin-bottom: 10px; font-size: 1em; }
        
        .measure-header { display: flex; align-items: center; gap: 8px; }
        .status-light { height: 12px; width: 12px; border-radius: 50%; flex-shrink: 0; }
        .status-green { background-color: #28a745; }
        .status-red { background-color: #dc3545; }

        .measure-title { font-weight: bold; color: #343a40; }
        .measure-dates { font-size: 0.8em; color: #6c757d; margin: 4px 0; display: block; }
        .comments-container { margin-top: 8px; border-left: 3px solid #007bff; padding-left: 10px; }
        .comment-item { font-size: 0.9em; color: #495057; margin-bottom: 4px; }
    </style>
</head>
<body>
    <h1>Dashboard de Medidas Educativas</h1>

    <div class="filters-wrapper">
        <div class="filter-container">
            <label for="course-filter">Selecciona un curso:</label>
            <select id="course-filter" onchange="handleCourseChange()"></select>
        </div>
        <div class="filter-container" id="class-filter-container" style="display: none;">
            <label for="class-filter">Filtrar por clase:</label>
            <select id="class-filter" onchange="filterStudents()"></select>
        </div>
    </div>

    <div id="dashboard-container"><p>Por favor, selecciona un curso para empezar.</p></div>

    <script>
        // El JavaScript no necesita cambios, es el mismo de la última versión
        const courseUrls={"1º ESO":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=12873044&single=true&output=csv","2º ESO":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=586029925&single=true&output=csv","3º ESO":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=932856573&single=true&output=csv","4º ESO":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=889532458&single=true&output=csv","1º BTO":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=1339435516&single=true&output=csv","2º BTO":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQBLzBraZXaIdUUQIZpEsvgCwxwSfyd8PVfQG2vZZ7V_uz92y6T6LrV82KM4EYEp9QW7cPaZFXi4Zga/pub?gid=732396135&single=true&output=csv"};
        let allStudents={};
        function handleCourseChange(){const e=document.getElementById("course-filter").value;e?loadStudentData(courseUrls[e]):(document.getElementById("dashboard-container").innerHTML="<p>Por favor, selecciona un curso para empezar.</p>",document.getElementById("class-filter-container").style.display="none")}
        async function loadStudentData(e){document.getElementById("dashboard-container").innerHTML="<p>Cargando datos del curso...</p>",document.getElementById("class-filter-container").style.display="none",allStudents={};try{const t=await fetch(e);if(!t.ok)throw new Error("Error al cargar los datos.");const o=await t.text(),n=parseCSV(o);n.forEach(e=>{const t=e.Nombre_Alumno;allStudents[t]||(allStudents[t]={name:t,class:e.Clase,measures:[]}),allStudents[t].measures.push({title:e.Medida_Educativa,comment:e.Comentario,startDate:e.Fecha_Inicio,endDate:e.Fecha_Fin})}),populateClassFilter(),displayDashboards(allStudents),document.getElementById("class-filter-container").style.display="block"}catch(e){document.getElementById("dashboard-container").innerHTML=`<p style="color: red;">${e.message}</p>`}}
        function populateCourseFilter(){const e=document.getElementById("course-filter");e.innerHTML='<option value="">-- Elige un curso --</option>';for(const t in courseUrls){const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)}}
        function populateClassFilter(){const e=document.getElementById("class-filter"),t=new Set;for(const o in allStudents)allStudents[o].class&&t.add(allStudents[o].class);const o=[...t].sort();e.innerHTML='<option value="todos">Todas las clases</option>',o.forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,e.appendChild(o)})}
        function displayDashboards(e){const t=document.getElementById("dashboard-container");if(t.innerHTML="",0===Object.keys(e).length)return void(t.innerHTML="<p>No hay alumnos para mostrar.</p>");for(const o in e){const n=e[o],a=document.createElement("div");a.className="student-card";const d=document.createElement("h3");d.textContent=n.name;const s=document.createElement("ul");n.measures.forEach(e=>{const o=document.createElement("li"),n=document.createElement("div");n.className="measure-header";const d=document.createElement("span");d.className="status-light",e.endDate&&""!==e.endDate.trim()&&"-"!==e.endDate.trim()?d.classList.add("status-red"):d.classList.add("status-green");const c=document.createElement("span");c.className="measure-title",c.textContent=e.title,n.appendChild(d),n.appendChild(c);const i=document.createElement("span");i.className="measure-dates",i.textContent=`(${e.startDate||""} - ${e.endDate||""})`,o.appendChild(n),o.appendChild(i),e.comment&&""!==e.comment.trim()&&"-"!==e.comment.trim()&&(()=>{const t=e.comment.split("||").map(e=>e.trim()).filter(e=>""!==e);if(t.length>0){const e=document.createElement("div");e.className="comments-container",t.forEach(t=>{const o=document.createElement("p");o.className="comment-item",o.textContent=t,e.appendChild(o)}),o.appendChild(e)}})(),s.appendChild(o)}),a.appendChild(d),a.appendChild(s),t.appendChild(a)}}
        function filterStudents(){const e=document.getElementById("class-filter").value;if("todos"===e)return void displayDashboards(allStudents);const t={};for(const o in allStudents)allStudents[o].class===e&&(t[o]=allStudents[o]);displayDashboards(t)}
        function parseCSV(e){const t=[],o=e.trim().split(/\r?\n(?=(?:[^"]*\"[^"]*\")*[^\"]*$)/);if(o.length<2)return t;const n=o[0].split(",").map(e=>e.trim());for(let e=1;e<o.length;e++){if(""===o[e].trim())continue;const a={},d=o[e].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)||[];for(let e=0;e<n.length;e++){if(!n[e])continue;let t=d[e]||"";t=t.trim(),'"'===t.startsWith('"')&&'"'===t.endsWith('"')&&(t=t.substring(1,t.length-1)),t=t.replace(/""/g,'"'),a[n[e]]=t}t.push(a)}return t}
        populateCourseFilter();
    </script>
</body>
</html>